<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biology Simulator - Enhanced V4</title>
    
    <style>
        /* Previous styles maintained... adding new components */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }
        
        .skip-link:focus {
            top: 0;
        }
        
        *:focus {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }
        
        .content {
            padding: 40px 30px;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }
        
        .info-box {
            background: #f7fafc;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 25px 0;
            border-radius: 4px;
        }
        
        .info-box.warning {
            border-left-color: #f56565;
            background: #fff5f5;
        }
        
        .info-box.success {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        /* NEW: Symptom Log Styles */
        .symptom-log {
            background: #fffaf0;
            border: 2px solid #ed8936;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            animation: pulse 2s ease-in-out;
        }
        
        .symptom-log.critical {
            background: #fff5f5;
            border-color: #f56565;
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(237, 137, 54, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(237, 137, 54, 0); }
        }
        
        .symptom-log h4 {
            color: #c05621;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .symptom-log.critical h4 {
            color: #c53030;
        }
        
        .symptom-log ul {
            margin-left: 20px;
            list-style: none;
        }
        
        .symptom-log li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        
        .symptom-log li:before {
            content: "‚ö†Ô∏è";
            position: absolute;
            left: 0;
        }
        
        .symptom-log.critical li:before {
            content: "üö®";
        }
        
        /* NEW: Hidden Damage Indicator */
        .hidden-damage-alert {
            background: linear-gradient(135deg, #fc8181 0%, #c53030 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(197, 48, 48, 0.3);
        }
        
        .hidden-damage-alert h3 {
            color: white;
            margin-bottom: 10px;
        }
        
        .damage-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .damage-metric-label {
            font-weight: 600;
        }
        
        .damage-metric-value {
            font-size: 1.5em;
            font-weight: 700;
        }
        
        /* Control Panel */
        .control-panel {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .control-row {
            margin-bottom: 25px;
        }
        
        .control-row:last-child {
            margin-bottom: 0;
        }
        
        .control-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
            color: #2d3748;
        }
        
        .radio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .radio-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .radio-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .radio-card:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        .radio-card input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .radio-card input[type="radio"]:checked + label {
            color: #667eea;
            font-weight: 600;
        }
        
        .radio-card.selected {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .radio-card label {
            cursor: pointer;
            display: block;
            font-weight: 500;
        }
        
        .radio-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .button:focus {
            outline: 3px solid #667eea;
            outline-offset: 3px;
        }
        
        .button-secondary {
            background: #718096;
        }
        
        .button-secondary:hover {
            background: #4a5568;
        }
        
        .button-full {
            width: 100%;
            margin-top: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        /* NEW: Choice Point Modal */
        .choice-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .choice-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        
        .choice-modal h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .choice-scenario {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .choice-scenario h3 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .choice-consequences {
            margin-top: 10px;
            padding: 10px;
            background: rgba(237, 137, 54, 0.1);
            border-radius: 4px;
        }
        
        .choice-consequences.bad {
            background: rgba(245, 101, 101, 0.1);
        }
        
        .choice-button {
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 1.1em;
        }
        
        /* Comparison Container */
        .comparison-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .comparison-side {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border: 3px solid #e2e8f0;
        }
        
        .comparison-side.scenario-a {
            border-color: #667eea;
        }
        
        .comparison-side.scenario-b {
            border-color: #48bb78;
        }
        
        .scenario-header {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 700;
            font-size: 1.2em;
            color: white;
        }
        
        .scenario-header.scenario-a {
            background: #667eea;
        }
        
        .scenario-header.scenario-b {
            background: #48bb78;
        }
        
        .chart-wrapper {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #2d3748;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: #f7fafc;
            border-radius: 4px;
        }
        
        .metric-label {
            font-weight: 600;
            color: #4a5568;
        }
        
        .metric-value {
            font-size: 1.3em;
            font-weight: 700;
        }
        
        .metric-value.good {
            color: #48bb78;
        }
        
        .metric-value.warning {
            color: #ed8936;
        }
        
        .metric-value.critical {
            color: #f56565;
        }
        
        /* NEW: Visual Chart Bars */
        .chart-container {
            height: 150px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            padding: 10px 0;
            border-bottom: 2px solid #cbd5e0;
            margin-top: 15px;
            background: #f7fafc;
            border-radius: 4px;
            padding: 10px;
        }
        
        .chart-bar {
            flex: 1;
            background: #667eea;
            border-radius: 4px 4px 0 0;
            transition: height 0.3s ease;
            position: relative;
            min-width: 8px;
        }
        
        .chart-bar:hover::after {
            content: attr(data-value);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3748;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            white-space: nowrap;
            margin-bottom: 4px;
        }
        
        .chart-bar.healthy { background: #48bb78; }
        .chart-bar.warning { background: #ed8936; }
        .chart-bar.critical { background: #f56565; }
        
        .play-button {
            font-size: 3em;
            background: #48bb78;
            color: white;
            border: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        
        .play-button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(72, 187, 120, 0.4);
        }
        
        .play-button.playing {
            background: #ed8936;
            box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3);
            animation: pulse-playing 2s ease-in-out infinite;
        }
        
        .play-button.playing:hover {
            box-shadow: 0 10px 30px rgba(237, 137, 54, 0.4);
        }
        
        @keyframes pulse-playing {
            0%, 100% { box-shadow: 0 4px 12px rgba(237, 137, 54, 0.3); }
            50% { box-shadow: 0 4px 20px rgba(237, 137, 54, 0.6); }
        }
        
        .timeline-event {
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #e2e8f0;
            background: #f7fafc;
            border-radius: 4px;
        }
        
        .timeline-event.milestone {
            border-left-color: #667eea;
            background: #edf2f7;
        }
        
        .timeline-event.warning {
            border-left-color: #ed8936;
            background: #fffaf0;
        }
        
        .timeline-event.critical {
            border-left-color: #f56565;
            background: #fff5f5;
        }
        
        .event-week {
            font-weight: 600;
            color: #667eea;
            margin-right: 10px;
        }
        
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .content {
                padding: 25px 20px;
            }
            
            .comparison-split {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button {
                width: 100%;
            }
        }
        
        @media (prefers-contrast: high) {
            .button {
                border: 2px solid currentColor;
            }
            
            .radio-card {
                border-width: 3px;
            }
        }
        
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        @media print {
            body {
                background: white;
            }
            
            .app-container {
                box-shadow: none;
            }
            
            .button, .skip-link, .choice-modal {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div id="sr-announcements" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Choice Point Modal (initially hidden) -->
    <div id="choice-modal" class="choice-modal" style="display: none;" role="dialog" aria-labelledby="choice-modal-title" aria-modal="true">
        <div class="choice-modal-content">
            <h2 id="choice-modal-title">‚ö†Ô∏è Week 6: Institutional Pressure</h2>
            
            <div class="info-box warning">
                <p><strong>The Extractive Dilemma:</strong> In extractive institutions, you are FORCED to choose between harms. Neither option is good. This is how toxic systems damage you regardless of your "choices."</p>
                <p style="margin-top: 10px;"><strong>In metabolic institutions, you are NOT FORCED into this dilemma.</strong> Values-aligned design means you don't face these impossible choices.</p>
            </div>
            
            <p style="margin: 20px 0;">Your institution is understaffed. To meet productivity targets, management demands you either:</p>
            
            <div class="choice-scenario">
                <h3>Option A: Comply</h3>
                <p>Cut corners to meet the quota. Ignore safety protocols. Push through despite knowing it's wrong.</p>
                <div class="choice-consequences bad">
                    <strong>Consequences:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Immediate stress reduced (avoid retaliation)</li>
                        <li>Moral Debt accumulates (+0.2 MFP)</li>
                        <li>Identity fragments (PRF damage)</li>
                        <li>Complicity in harm</li>
                    </ul>
                </div>
                <button class="button choice-button" onclick="makeChoice('comply')" aria-label="Choose to comply with institutional demands">Choose to Comply</button>
            </div>
            
            <div class="choice-scenario">
                <h3>Option B: Resist</h3>
                <p>Refuse to cut corners. Maintain standards. Document the unsafe conditions. Speak up.</p>
                <div class="choice-consequences bad">
                    <strong>Consequences:</strong>
                    <ul style="margin-left: 20px; margin-top: 5px;">
                        <li>Retaliation (write-up, job threat)</li>
                        <li>Stress increases sharply (+0.15 L_GC)</li>
                        <li>PRF remains intact (values upheld)</li>
                        <li>But personal cost is high</li>
                    </ul>
                </div>
                <button class="button choice-button button-secondary" onclick="makeChoice('resist')" aria-label="Choose to resist institutional demands">Choose to Resist</button>
            </div>
            
            <div class="info-box">
                <h3>üéØ The Lesson:</h3>
                <p><strong>Both choices harm you in different ways.</strong> This is the signature of extractive institutional design: forcing false dilemmas where you lose either way.</p>
                <p style="margin-top: 10px;"><strong>The problem is not your choice. The problem is being FORCED to make this choice.</strong></p>
                <p style="margin-top: 10px;"><strong>Metabolic institutions don't put you in this position.</strong> They provide resources, autonomy, and values alignment so you're not forced between your integrity and your survival.</p>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <header class="header" role="banner">
            <h1>üß™ Biology Simulator - Enhanced</h1>
            <p>See Your Brain Under Stress - Now with Hidden Damage Tracking</p>
        </header>
        
        <main class="content" id="main-content" role="main">
            <!-- Welcome section would go here - keeping brief for length -->
            
            <!-- COMPARISON SETUP SECTION -->
            <section id="comparison-setup" class="section active" aria-labelledby="comparison-heading">
                <h2 id="comparison-heading" style="color: #667eea; margin-bottom: 20px; text-align: center;">Side-by-Side Comparison</h2>
                
                <p style="text-align: center; margin-bottom: 20px; color: #718096;">Configure two scenarios and watch them run simultaneously</p>
                
                <div class="info-box">
                    <h3>üî¨ New Feature: Silent Damage Tracking</h3>
                    <p><strong>Dandelions (low sensitivity) now tracked for hidden costs:</strong></p>
                    <ul style="margin-left: 25px; margin-top: 10px;">
                        <li><strong>GrimAge Biological Aging:</strong> Epigenetic clock acceleration</li>
                        <li><strong>Cardiovascular Risk:</strong> Silent arterial damage accumulation</li>
                        <li><strong>The Dangerous Reality:</strong> FHRI 55 (appearing "functional") + 1.8 years biological aging = WORSE total harm than orchid's visible collapse at FHRI 35</li>
                    </ul>
                    <p style="margin-top: 10px; font-weight: bold;">High turnover (orchids fleeing) is the WARNING SIGN. Low turnover (dandelions enduring) masks catastrophic damage.</p>
                </div>
                
                <div class="comparison-split">
                    <div class="comparison-side scenario-a" role="region" aria-labelledby="scenario-a-heading">
                        <h3 class="scenario-header scenario-a" id="scenario-a-heading">SCENARIO A</h3>
                        
                        <form aria-label="Scenario A configuration">
                            <fieldset class="control-row">
                                <legend style="font-weight: 600; margin-bottom: 10px;">Sensitivity:</legend>
                                <select id="comp-sens-a" style="width: 100%; padding: 10px; border-radius: 4px; border: 2px solid #e2e8f0; font-size: 1em;" aria-label="Scenario A environmental sensitivity">
                                    <option value="">Select...</option>
                                    <option value="orchid">Orchid üå∏ (High Sensitivity)</option>
                                    <option value="tulip">Tulip üå∑ (Balanced)</option>
                                    <option value="dandelion">Dandelion üåº (Low Sensitivity)</option>
                                </select>
                            </fieldset>
                            
                            <fieldset class="control-row">
                                <legend style="font-weight: 600; margin-bottom: 10px;">Stress Style:</legend>
                                <select id="comp-stress-a" style="width: 100%; padding: 10px; border-radius: 4px; border: 2px solid #e2e8f0; font-size: 1em;" aria-label="Scenario A stress response style">
                                    <option value="">Select...</option>
                                    <option value="warrior">Warrior üõ°Ô∏è (Good Under Pressure)</option>
                                    <option value="balanced">Balanced ‚öñÔ∏è (Moderate)</option>
                                    <option value="worrier">Worrier üîç (Best When Calm)</option>
                                </select>
                            </fieldset>
                            
                            <fieldset class="control-row">
                                <legend style="font-weight: 600; margin-bottom: 10px;">Environment:</legend>
                                <select id="comp-env-a" style="width: 100%; padding: 10px; border-radius: 4px; border: 2px solid #e2e8f0; font-size: 1em;" aria-label="Scenario A institutional environment">
                                    <option value="">Select...</option>
                                    <option value="extractive">Extractive ‚õìÔ∏è (No Autonomy)</option>
                                    <option value="metabolic">Metabolic üå± (Values-Aligned)</option>
                                </select>
                            </fieldset>
                            
                            <div class="control-row">
                                <label for="comp-biobond-a" style="font-weight: 600; margin-bottom: 10px; display: block;">BioBond: <span id="comp-biobond-display-a" aria-live="polite">50%</span></label>
                                <input 
                                    type="range" 
                                    id="comp-biobond-a" 
                                    min="0" 
                                    max="100" 
                                    value="50" 
                                    oninput="document.getElementById('comp-biobond-display-a').textContent = this.value + '%'"
                                    style="width: 100%;"
                                    aria-label="Scenario A BioBond level"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                    aria-valuenow="50">
                                <div style="margin-top: 10px;">
                                    <button type="button" class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em; margin-right: 5px;" onclick="setBiobond('a', 10)">Crisis (10%)</button>
                                    <button type="button" class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em; margin-right: 5px;" onclick="setBiobond('a', 40)">Average (40%)</button>
                                    <button type="button" class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em;" onclick="setBiobond('a', 80)">Optimized (80%)</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <div class="comparison-side scenario-b" role="region" aria-labelledby="scenario-b-heading">
                        <h3 class="scenario-header scenario-b" id="scenario-b-heading">SCENARIO B</h3>
                        
                        <form aria-label="Scenario B configuration">
                            <fieldset class="control-row">
                                <legend style="font-weight: 600; margin-bottom: 10px;">Sensitivity:</legend>
                                <select id="comp-sens-b" style="width: 100%; padding: 10px; border-radius: 4px; border: 2px solid #e2e8f0; font-size: 1em;" aria-label="Scenario B environmental sensitivity">
                                    <option value="">Select...</option>
                                    <option value="orchid">Orchid üå∏ (High Sensitivity)</option>
                                    <option value="tulip">Tulip üå∑ (Balanced)</option>
                                    <option value="dandelion">Dandelion üåº (Low Sensitivity)</option>
                                </select>
                            </fieldset>
                            
                            <fieldset class="control-row">
                                <legend style="font-weight: 600; margin-bottom: 10px;">Stress Style:</legend>
                                <select id="comp-stress-b" style="width: 100%; padding: 10px; border-radius: 4px; border: 2px solid #e2e8f0; font-size: 1em;" aria-label="Scenario B stress response style">
                                    <option value="">Select...</option>
                                    <option value="warrior">Warrior üõ°Ô∏è (Good Under Pressure)</option>
                                    <option value="balanced">Balanced ‚öñÔ∏è (Moderate)</option>
                                    <option value="worrier">Worrier üîç (Best When Calm)</option>
                                </select>
                            </fieldset>
                            
                            <fieldset class="control-row">
                                <legend style="font-weight: 600; margin-bottom: 10px;">Environment:</legend>
                                <select id="comp-env-b" style="width: 100%; padding: 10px; border-radius: 4px; border: 2px solid #e2e8f0; font-size: 1em;" aria-label="Scenario B institutional environment">
                                    <option value="">Select...</option>
                                    <option value="extractive">Extractive ‚õìÔ∏è (No Autonomy)</option>
                                    <option value="metabolic">Metabolic üå± (Values-Aligned)</option>
                                </select>
                            </fieldset>
                            
                            <div class="control-row">
                                <label for="comp-biobond-b" style="font-weight: 600; margin-bottom: 10px; display: block;">BioBond: <span id="comp-biobond-display-b" aria-live="polite">50%</span></label>
                                <input 
                                    type="range" 
                                    id="comp-biobond-b" 
                                    min="0" 
                                    max="100" 
                                    value="50" 
                                    oninput="document.getElementById('comp-biobond-display-b').textContent = this.value + '%'"
                                    style="width: 100%;"
                                    aria-label="Scenario B BioBond level"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                    aria-valuenow="50">
                                <div style="margin-top: 10px;">
                                    <button type="button" class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em; margin-right: 5px;" onclick="setBiobond('b', 10)">Crisis (10%)</button>
                                    <button type="button" class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em; margin-right: 5px;" onclick="setBiobond('b', 40)">Average (40%)</button>
                                    <button type="button" class="button button-secondary" style="padding: 8px 15px; font-size: 0.9em;" onclick="setBiobond('b', 80)">Optimized (80%)</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <nav aria-label="Comparison actions">
                    <div class="button-group" style="justify-content: center;">
                        <button class="button" onclick="runComparison()" aria-label="Run side-by-side comparison">Run Comparison ‚Üí</button>
                    </div>
                </nav>
            </section>
            
            <!-- COMPARISON RESULTS SECTION -->
            <section id="comparison-results" class="section" aria-labelledby="comparison-results-heading">
                <h2 id="comparison-results-heading" style="color: #667eea; margin-bottom: 20px; text-align: center;">Comparison Results</h2>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <p style="font-size: 1.2em; font-weight: 600; margin-bottom: 10px;">Week <span id="comp-week-display">0</span> of 12</p>
                    
                    <!-- Play Controls -->
                    <div style="margin-bottom: 20px;">
                        <button class="play-button" id="comp-play-button" onclick="toggleComparisonPlay()" aria-label="Play or pause comparison simulation">‚ñ∂Ô∏è</button>
                        <button class="button" onclick="stepForward()" style="padding: 15px 30px; font-size: 1.1em; margin-left: 15px;" aria-label="Advance one week">Next Week ‚Üí</button>
                    </div>
                    
                    <!-- Speed Control -->
                    <div style="max-width: 400px; margin: 0 auto 20px; padding: 20px; background: #f7fafc; border-radius: 8px; border: 2px solid #e2e8f0;">
                        <label for="speed-control" style="font-weight: 600; margin-bottom: 10px; display: block;">
                            Simulation Speed: <span id="speed-display" aria-live="polite">3 seconds per week</span>
                        </label>
                        <input 
                            type="range" 
                            id="speed-control" 
                            min="1" 
                            max="5" 
                            value="3" 
                            step="1"
                            oninput="updateSpeed()"
                            style="width: 100%;"
                            aria-label="Simulation speed from 1 to 5 seconds per week"
                            aria-valuemin="1"
                            aria-valuemax="5"
                            aria-valuenow="3">
                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.85em; color: #718096;">
                            <span>Fast (1s)</span>
                            <span>Moderate (3s)</span>
                            <span>Slow (5s)</span>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #4a5568; text-align: left;">
                            <strong>Tip:</strong> Use slower speeds to read symptom logs and watch metrics change. Use "Next Week" button to examine each week carefully.
                        </p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="button button-secondary" onclick="resetComparison()" style="padding: 10px 30px; font-size: 1em;" aria-label="Reset comparison simulation">Reset</button>
                    </div>
                </div>
                
                <div class="comparison-split">
                    <!-- Scenario A Results -->
                    <div class="comparison-side scenario-a" role="region" aria-labelledby="results-a-heading">
                        <h3 class="scenario-header scenario-a" id="results-a-heading">SCENARIO A</h3>
                        <p id="comp-description-a" style="text-align: center; margin-bottom: 20px; font-size: 0.95em; color: #4a5568;"></p>
                        
                        <!-- NEW: Symptom Log A -->
                        <div id="symptom-log-a" style="display: none;"></div>
                        
                        <div class="chart-wrapper">
                            <div class="metric-row">
                                <span class="metric-label">FHRI:</span>
                                <span id="comp-fhri-a" class="metric-value good" aria-label="Scenario A functional capacity">78</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">C_PFC:</span>
                                <span id="comp-cpfc-a" class="metric-value good" aria-label="Scenario A prefrontal cortex capacity">85%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">L_GC:</span>
                                <span id="comp-lgc-a" class="metric-value good" aria-label="Scenario A glucocorticoid load">40%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">MFP:</span>
                                <span id="comp-mfp-a" class="metric-value good" aria-label="Scenario A moral debt">0%</span>
                            </div>
                            
                            <!-- NEW: Visual Chart A -->
                            <div style="margin-top: 20px;">
                                <h4 style="font-size: 0.9em; text-align: center; color: #718096; margin-bottom: 10px;">FHRI Trajectory</h4>
                                <div id="chart-a" class="chart-container" role="img" aria-label="Bar chart showing FHRI levels over 12 weeks"></div>
                            </div>
                        </div>
                        
                        <!-- NEW: Hidden Damage Alert A -->
                        <div id="hidden-damage-a" style="display: none;"></div>
                        
                        <div id="comp-timeline-a" style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; max-height: 200px; overflow-y: auto;" role="log" aria-label="Scenario A timeline of events">
                            <p style="font-weight: 600; margin-bottom: 10px;">Timeline:</p>
                            <div class="timeline-event milestone">
                                <span class="event-week">Week 0:</span> Simulation begins
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scenario B Results -->
                    <div class="comparison-side scenario-b" role="region" aria-labelledby="results-b-heading">
                        <h3 class="scenario-header scenario-b" id="results-b-heading">SCENARIO B</h3>
                        <p id="comp-description-b" style="text-align: center; margin-bottom: 20px; font-size: 0.95em; color: #4a5568;"></p>
                        
                        <!-- NEW: Symptom Log B -->
                        <div id="symptom-log-b" style="display: none;"></div>
                        
                        <div class="chart-wrapper">
                            <div class="metric-row">
                                <span class="metric-label">FHRI:</span>
                                <span id="comp-fhri-b" class="metric-value good" aria-label="Scenario B functional capacity">78</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">C_PFC:</span>
                                <span id="comp-cpfc-b" class="metric-value good" aria-label="Scenario B prefrontal cortex capacity">85%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">L_GC:</span>
                                <span id="comp-lgc-b" class="metric-value good" aria-label="Scenario B glucocorticoid load">40%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">MFP:</span>
                                <span id="comp-mfp-b" class="metric-value good" aria-label="Scenario B moral debt">0%</span>
                            </div>
                            
                            <!-- NEW: Visual Chart B -->
                            <div style="margin-top: 20px;">
                                <h4 style="font-size: 0.9em; text-align: center; color: #718096; margin-bottom: 10px;">FHRI Trajectory</h4>
                                <div id="chart-b" class="chart-container" role="img" aria-label="Bar chart showing FHRI levels over 12 weeks"></div>
                            </div>
                        </div>
                        
                        <!-- NEW: Hidden Damage Alert B -->
                        <div id="hidden-damage-b" style="display: none;"></div>
                        
                        <div id="comp-timeline-b" style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; max-height: 200px; overflow-y: auto;" role="log" aria-label="Scenario B timeline of events">
                            <p style="font-weight: 600; margin-bottom: 10px;">Timeline:</p>
                            <div class="timeline-event milestone">
                                <span class="event-week">Week 0:</span> Simulation begins
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="comp-final-summary" style="display: none; margin-top: 30px;" role="region" aria-labelledby="comp-summary-heading">
                    <h3 id="comp-summary-heading" style="color: #667eea; text-align: center; margin-bottom: 20px;">Comparison Summary</h3>
                    <div id="comp-summary-content" class="info-box"></div>
                </div>
                
                <nav aria-label="After comparison actions">
                    <div class="button-group">
                        <button class="button button-secondary" onclick="showSection('comparison-setup')" aria-label="Go back to comparison setup">‚Üê New Comparison</button>
                    </div>
                </nav>
            </section>
        </main>
    </div>
    
    <script>
        // ===================================================================
        // ENHANCED BIOLOGY SIMULATOR V4 - JAVASCRIPT
        // ===================================================================
        
        function announce(message) {
            const announcer = document.getElementById('sr-announcements');
            announcer.textContent = message;
            setTimeout(() => announcer.textContent = '', 1000);
        }
        
        let comparisonState = {
            week: 0,
            isRunning: false,
            intervalId: null,
            choicePointShown: false,
            speed: 3000, // milliseconds per week (default 3 seconds)
            autoPauseOnCritical: true,
            scenarioA: {
                sensitivity: null,
                stress: null,
                environment: null,
                biobond: 50,
                data: { lgc: [0.4], cpfc: [0.85], mfp: [0], fhri: [78], grimAge: [0], cvRisk: [0] },
                events: [],
                choiceMade: null
            },
            scenarioB: {
                sensitivity: null,
                stress: null,
                environment: null,
                biobond: 50,
                data: { lgc: [0.4], cpfc: [0.85], mfp: [0], fhri: [78], grimAge: [0], cvRisk: [0] },
                events: [],
                choiceMade: null
            }
        };
        
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            window.scrollTo(0, 0);
            
            const sectionHeading = document.querySelector(`#${sectionId} h2`);
            if (sectionHeading) {
                announce(`Navigated to ${sectionHeading.textContent}`);
            }
        }
        
        function setBiobond(scenario, value) {
            document.getElementById(`comp-biobond-${scenario}`).value = value;
            document.getElementById(`comp-biobond-display-${scenario}`).textContent = value + '%';
            announce(`Set ${scenario === 'a' ? 'Scenario A' : 'Scenario B'} BioBond to ${value} percent`);
        }
        
        function updateSpeed() {
            const speedValue = parseInt(document.getElementById('speed-control').value);
            comparisonState.speed = speedValue * 1000; // Convert to milliseconds
            document.getElementById('speed-display').textContent = `${speedValue} second${speedValue > 1 ? 's' : ''} per week`;
            
            // If simulation is running, restart with new speed
            if (comparisonState.isRunning) {
                clearInterval(comparisonState.intervalId);
                startInterval();
            }
            
            announce(`Speed set to ${speedValue} seconds per week`);
        }
        
        function stepForward() {
            // If already at week 12, don't advance
            if (comparisonState.week >= 12) {
                announce('Simulation complete at week 12');
                return;
            }
            
            // Pause if running
            if (comparisonState.isRunning) {
                pauseComparison();
            }
            
            // Check for choice point at week 6
            if (comparisonState.week === 5 && !comparisonState.choicePointShown) {
                if (comparisonState.scenarioA.environment === 'extractive' || comparisonState.scenarioB.environment === 'extractive') {
                    showChoicePoint();
                    return;
                }
            }
            
            // Advance one week
            advanceComparisonWeek();
            
            // Check if complete
            if (comparisonState.week >= 12) {
                showComparisonSummary();
            }
        }
        
        function runComparison() {
            const sensA = document.getElementById('comp-sens-a').value;
            const stressA = document.getElementById('comp-stress-a').value;
            const envA = document.getElementById('comp-env-a').value;
            const sensB = document.getElementById('comp-sens-b').value;
            const stressB = document.getElementById('comp-stress-b').value;
            const envB = document.getElementById('comp-env-b').value;
            
            if (!sensA || !stressA || !envA) {
                alert('Please configure all options for Scenario A');
                return;
            }
            if (!sensB || !stressB || !envB) {
                alert('Please configure all options for Scenario B');
                return;
            }
            
            comparisonState.week = 0;
            comparisonState.choicePointShown = false;
            comparisonState.scenarioA = {
                sensitivity: sensA,
                stress: stressA,
                environment: envA,
                biobond: parseInt(document.getElementById('comp-biobond-a').value),
                data: { lgc: [calculateInitialLGC(sensA)], cpfc: [0.85], mfp: [0], fhri: [78], grimAge: [0], cvRisk: [0] },
                events: [{week: 0, type: 'milestone', text: 'Simulation begins'}],
                choiceMade: null
            };
            comparisonState.scenarioB = {
                sensitivity: sensB,
                stress: stressB,
                environment: envB,
                biobond: parseInt(document.getElementById('comp-biobond-b').value),
                data: { lgc: [calculateInitialLGC(sensB)], cpfc: [0.85], mfp: [0], fhri: [78], grimAge: [0], cvRisk: [0] },
                events: [{week: 0, type: 'milestone', text: 'Simulation begins'}],
                choiceMade: null
            };
            
            showSection('comparison-results');
            
            document.getElementById('comp-description-a').textContent = 
                `${capitalize(sensA)}-${capitalize(stressA)} in ${capitalize(envA)} (${comparisonState.scenarioA.biobond}% BioBond)`;
            document.getElementById('comp-description-b').textContent = 
                `${capitalize(sensB)}-${capitalize(stressB)} in ${capitalize(envB)} (${comparisonState.scenarioB.biobond}% BioBond)`;
            
            updateComparisonDisplay();
            
            announce('Comparison initialized. Press play to start both simulations.');
        }
        
        function calculateInitialLGC(sensitivity) {
            const baseLGC = {
                'orchid': 0.45,
                'tulip': 0.40,
                'dandelion': 0.35
            };
            return baseLGC[sensitivity];
        }
        
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function toggleComparisonPlay() {
            if (comparisonState.isRunning) {
                pauseComparison();
            } else {
                playComparison();
            }
        }
        
        function playComparison() {
            comparisonState.isRunning = true;
            document.getElementById('comp-play-button').textContent = '‚è∏Ô∏è';
            document.getElementById('comp-play-button').classList.add('playing');
            document.getElementById('comp-play-button').setAttribute('aria-label', 'Pause comparison simulation');
            announce('Comparison simulation playing');
            
            startInterval();
        }
        
        function startInterval() {
            comparisonState.intervalId = setInterval(() => {
                // Check for choice point at week 6 in extractive environments
                if (comparisonState.week === 5 && !comparisonState.choicePointShown) {
                    if (comparisonState.scenarioA.environment === 'extractive' || comparisonState.scenarioB.environment === 'extractive') {
                        pauseComparison();
                        showChoicePoint();
                        return;
                    }
                }
                
                advanceComparisonWeek();
                
                // Auto-pause on critical events if enabled
                if (comparisonState.autoPauseOnCritical) {
                    const lastEventA = comparisonState.scenarioA.events[comparisonState.scenarioA.events.length - 1];
                    const lastEventB = comparisonState.scenarioB.events[comparisonState.scenarioB.events.length - 1];
                    
                    if ((lastEventA && lastEventA.type === 'critical' && lastEventA.week === comparisonState.week) ||
                        (lastEventB && lastEventB.type === 'critical' && lastEventB.week === comparisonState.week)) {
                        pauseComparison();
                        announce(`Paused at week ${comparisonState.week} - critical event occurred. Press play to continue or use Next Week button.`);
                        return;
                    }
                }
                
                if (comparisonState.week >= 12) {
                    pauseComparison();
                    showComparisonSummary();
                }
            }, comparisonState.speed); // Use variable speed
        }
        
        function pauseComparison() {
            comparisonState.isRunning = false;
            document.getElementById('comp-play-button').textContent = '‚ñ∂Ô∏è';
            document.getElementById('comp-play-button').classList.remove('playing');
            document.getElementById('comp-play-button').setAttribute('aria-label', 'Play comparison simulation');
            clearInterval(comparisonState.intervalId);
            announce('Comparison simulation paused');
        }
        
        function showChoicePoint() {
            comparisonState.choicePointShown = true;
            document.getElementById('choice-modal').style.display = 'flex';
            announce('Week 6 choice point reached. Institution forcing a decision.');
        }
        
        function makeChoice(choice) {
            document.getElementById('choice-modal').style.display = 'none';
            
            // Apply choice consequences to both scenarios if in extractive
            if (comparisonState.scenarioA.environment === 'extractive') {
                comparisonState.scenarioA.choiceMade = choice;
                if (choice === 'comply') {
                    // Lower immediate stress, higher moral debt
                    comparisonState.scenarioA.data.lgc[comparisonState.week] -= 0.1;
                    comparisonState.scenarioA.data.mfp[comparisonState.week] += 0.2;
                    comparisonState.scenarioA.events.push({week: comparisonState.week, type: 'warning', text: 'Complied with unsafe demand. Moral debt increased.'});
                } else {
                    // Higher stress, maintained integrity
                    comparisonState.scenarioA.data.lgc[comparisonState.week] += 0.15;
                    comparisonState.scenarioA.events.push({week: comparisonState.week, type: 'warning', text: 'Resisted demand. Facing retaliation, but values intact.'});
                }
            }
            
            if (comparisonState.scenarioB.environment === 'extractive') {
                comparisonState.scenarioB.choiceMade = choice;
                if (choice === 'comply') {
                    comparisonState.scenarioB.data.lgc[comparisonState.week] -= 0.1;
                    comparisonState.scenarioB.data.mfp[comparisonState.week] += 0.2;
                    comparisonState.scenarioB.events.push({week: comparisonState.week, type: 'warning', text: 'Complied with unsafe demand. Moral debt increased.'});
                } else {
                    comparisonState.scenarioB.data.lgc[comparisonState.week] += 0.15;
                    comparisonState.scenarioB.events.push({week: comparisonState.week, type: 'warning', text: 'Resisted demand. Facing retaliation, but values intact.'});
                }
            }
            
            updateComparisonDisplay();
            announce(`Choice made: ${choice}. Continuing simulation.`);
            playComparison();
        }
        
        function advanceComparisonWeek() {
            comparisonState.week++;
            document.getElementById('comp-week-display').textContent = comparisonState.week;
            
            calculateScenarioWeek(comparisonState.scenarioA, comparisonState.week);
            calculateScenarioWeek(comparisonState.scenarioB, comparisonState.week);
            
            updateComparisonDisplay();
            
            // Announce progress every 2 weeks or on critical events
            if (comparisonState.week % 2 === 0) {
                announce(`Week ${comparisonState.week} of 12`);
            }
            
            // Scroll to latest events in timelines
            const timelineA = document.getElementById('comp-timeline-a');
            const timelineB = document.getElementById('comp-timeline-b');
            if (timelineA) timelineA.scrollTop = timelineA.scrollHeight;
            if (timelineB) timelineB.scrollTop = timelineB.scrollHeight;
        }
        
        function calculateScenarioWeek(scenario, week) {
            const prevLGC = scenario.data.lgc[week - 1];
            const prevCPFC = scenario.data.cpfc[week - 1];
            const prevMFP = scenario.data.mfp[week - 1];
            const prevGrimAge = scenario.data.grimAge[week - 1];
            const prevCVRisk = scenario.data.cvRisk[week - 1];
            
            const stressInput = scenario.environment === 'extractive' ? 0.15 : 0.05;
            
            const sensModifier = {
                'orchid': 1.5,
                'tulip': 1.0,
                'dandelion': 0.7
            }[scenario.sensitivity];
            
            const biobondEffect = scenario.biobond / 100;
            
            // Calculate new L_GC
            const stressAccumulation = stressInput * sensModifier * (1 - biobondEffect * 0.6);
            const recovery = 0.02 * biobondEffect;
            let newLGC = prevLGC + stressAccumulation - recovery;
            newLGC = Math.max(0.1, Math.min(1.0, newLGC));
            
            // Calculate new C_PFC
            let newCPFC = 0.95 - (newLGC * 0.8);
            if (scenario.stress === 'warrior' && scenario.environment === 'extractive') {
                newCPFC += 0.05;
            } else if (scenario.stress === 'worrier' && scenario.environment === 'extractive') {
                newCPFC -= 0.08;
            }
            newCPFC = Math.max(0.1, Math.min(0.95, newCPFC));
            
            // Calculate Moral Debt
            let newMFP = prevMFP;
            if (scenario.environment === 'extractive') {
                const moralDebtAccrual = 0.04 * (1 - biobondEffect * 0.5);
                newMFP += moralDebtAccrual;
            } else {
                newMFP = Math.max(0, newMFP - 0.02);
            }
            newMFP = Math.max(0, Math.min(1.0, newMFP));
            
            // NEW: Calculate Hidden Damage for Dandelions
            let newGrimAge = prevGrimAge;
            let newCVRisk = prevCVRisk;
            
            if (scenario.sensitivity === 'dandelion' && scenario.environment === 'extractive') {
                // Dandelions accumulate silent damage even when FHRI appears functional
                // GrimAge accelerates (~0.15 years per week in extractive environment)
                const grimAgeRate = 0.15 * (1 - biobondEffect * 0.4);
                newGrimAge += grimAgeRate;
                
                // Cardiovascular risk accumulates (~3% per week)
                const cvRiskRate = 3 * (1 - biobondEffect * 0.3);
                newCVRisk += cvRiskRate;
            }
            
            // Calculate FHRI
            const fhriBase = 100 * (0.4 * newCPFC + 0.3 * (1 - newLGC) + 0.3 * (1 - newMFP));
            let newFHRI = fhriBase;
            if (scenario.environment === 'metabolic') {
                newFHRI += 10;
            } else {
                newFHRI -= 5;
            }
            newFHRI = Math.max(10, Math.min(100, newFHRI));
            
            // Store values
            scenario.data.lgc.push(newLGC);
            scenario.data.cpfc.push(newCPFC);
            scenario.data.mfp.push(newMFP);
            scenario.data.fhri.push(newFHRI);
            scenario.data.grimAge.push(newGrimAge);
            scenario.data.cvRisk.push(newCVRisk);
            
            checkScenarioThresholds(scenario, week, newLGC, newCPFC, newMFP, newFHRI, newGrimAge, newCVRisk);
        }
        
        function checkScenarioThresholds(scenario, week, lgc, cpfc, mfp, fhri, grimAge, cvRisk) {
            if (cpfc < 0.6 && scenario.data.cpfc[week - 1] >= 0.6) {
                scenario.events.push({week, type: 'warning', text: 'PFC capacity below 60% - ethical reasoning compromised'});
            }
            if (cpfc < 0.4 && scenario.data.cpfc[week - 1] >= 0.4) {
                scenario.events.push({week, type: 'critical', text: 'PFC critically depleted - automatic mode only'});
            }
            if (lgc > 0.7 && scenario.data.lgc[week - 1] <= 0.7) {
                scenario.events.push({week, type: 'warning', text: 'Chronic stress - hippocampal atrophy beginning'});
            }
            if (mfp > 0.5 && scenario.data.mfp[week - 1] <= 0.5) {
                scenario.events.push({week, type: 'warning', text: 'Significant moral debt - identity fragmentation'});
            }
            if (fhri < 50 && scenario.data.fhri[week - 1] >= 50) {
                scenario.events.push({week, type: 'critical', text: 'FHRI below 50 - burnout zone, exit recommended'});
            }
            
            // NEW: Hidden damage warnings for dandelions
            if (scenario.sensitivity === 'dandelion') {
                if (grimAge > 1.0 && scenario.data.grimAge[week - 1] <= 1.0) {
                    scenario.events.push({week, type: 'warning', text: 'GrimAge +1 year - epigenetic aging accelerating'});
                }
                if (cvRisk > 30 && scenario.data.cvRisk[week - 1] <= 30) {
                    scenario.events.push({week, type: 'critical', text: 'Cardiovascular risk elevated 30% - silent arterial damage'});
                }
            }
        }
        
        function updateComparisonDisplay() {
            const week = comparisonState.week;
            
            updateScenarioDisplay('a', comparisonState.scenarioA, week);
            updateScenarioDisplay('b', comparisonState.scenarioB, week);
        }
        
        function updateScenarioDisplay(id, scenario, week) {
            const fhri = scenario.data.fhri[week];
            const cpfc = scenario.data.cpfc[week];
            const lgc = scenario.data.lgc[week];
            const mfp = scenario.data.mfp[week];
            const grimAge = scenario.data.grimAge[week];
            const cvRisk = scenario.data.cvRisk[week];
            
            // Update metric displays
            const fhriEl = document.getElementById(`comp-fhri-${id}`);
            fhriEl.textContent = Math.round(fhri);
            fhriEl.className = 'metric-value ' + (fhri >= 70 ? 'good' : fhri >= 50 ? 'warning' : 'critical');
            
            const cpfcEl = document.getElementById(`comp-cpfc-${id}`);
            cpfcEl.textContent = Math.round(cpfc * 100) + '%';
            cpfcEl.className = 'metric-value ' + (cpfc >= 0.6 ? 'good' : cpfc >= 0.4 ? 'warning' : 'critical');
            
            const lgcEl = document.getElementById(`comp-lgc-${id}`);
            lgcEl.textContent = Math.round(lgc * 100) + '%';
            lgcEl.className = 'metric-value ' + (lgc <= 0.6 ? 'good' : lgc <= 0.8 ? 'warning' : 'critical');
            
            const mfpEl = document.getElementById(`comp-mfp-${id}`);
            mfpEl.textContent = Math.round(mfp * 100) + '%';
            mfpEl.className = 'metric-value ' + (mfp <= 0.4 ? 'good' : mfp <= 0.7 ? 'warning' : 'critical');
            
            // NEW: Update visual chart
            updateVisualChart(id, scenario, week);
            
            // NEW: Update symptom log
            updateSymptomLog(id, scenario, week);
            
            // NEW: Update hidden damage display for dandelions
            if (scenario.sensitivity === 'dandelion' && scenario.environment === 'extractive') {
                updateHiddenDamage(id, grimAge, cvRisk, fhri);
            } else {
                document.getElementById(`hidden-damage-${id}`).style.display = 'none';
            }
            
            // Update timeline
            const timelineEl = document.getElementById(`comp-timeline-${id}`);
            const eventsHtml = scenario.events.map(event => `
                <div class="timeline-event ${event.type}">
                    <span class="event-week">Week ${event.week}:</span> ${event.text}
                </div>
            `).join('');
            timelineEl.innerHTML = '<p style="font-weight: 600; margin-bottom: 10px;">Timeline:</p>' + eventsHtml;
            timelineEl.scrollTop = timelineEl.scrollHeight;
        }
        
        // NEW: Visual chart update function
        function updateVisualChart(id, scenario, week) {
            const chartContainer = document.getElementById(`chart-${id}`);
            
            if (week === 0) chartContainer.innerHTML = '';
            
            const fhri = scenario.data.fhri[week];
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            
            bar.style.height = `${Math.max(5, fhri)}%`;
            
            if (fhri >= 70) bar.classList.add('healthy');
            else if (fhri >= 50) bar.classList.add('warning');
            else bar.classList.add('critical');
            
            bar.setAttribute('data-value', `W${week}: ${Math.round(fhri)}`);
            bar.setAttribute('aria-label', `Week ${week}: FHRI ${Math.round(fhri)}`);
            
            chartContainer.appendChild(bar);
        }
        
        // NEW: Symptom log function
        function updateSymptomLog(id, scenario, week) {
            const logEl = document.getElementById(`symptom-log-${id}`);
            const cpfc = scenario.data.cpfc[week];
            const lgc = scenario.data.lgc[week];
            const mfp = scenario.data.mfp[week];
            
            const symptoms = [];
            
            if (cpfc < 0.4) {
                symptoms.push("You snap at colleagues over minor issues");
                symptoms.push("Cannot focus on complex tasks");
                symptoms.push("Ethical reasoning feels impossible");
            } else if (cpfc < 0.6) {
                symptoms.push("Difficulty thinking through decisions");
                symptoms.push("Procrastinating on important work");
            }
            
            if (lgc > 0.8) {
                symptoms.push("Can't remember what you read");
                symptoms.push("Physical tension (jaw clenched, shoulders tight)");
            } else if (lgc > 0.7) {
                symptoms.push("Sleep disrupted despite exhaustion");
                symptoms.push("Minor stressors feel overwhelming");
            }
            
            if (mfp > 0.7) {
                symptoms.push("Feel like a fraud or hypocrite");
                symptoms.push("Cynicism about values you once held");
            } else if (mfp > 0.5) {
                symptoms.push("Guilt about cutting corners");
                symptoms.push("Avoiding thinking about work values");
            }
            
            if (symptoms.length > 0) {
                const isCritical = cpfc < 0.4 || lgc > 0.8 || mfp > 0.7;
                logEl.className = isCritical ? 'symptom-log critical' : 'symptom-log';
                logEl.style.display = 'block';
                logEl.innerHTML = `
                    <h4>${isCritical ? 'üö®' : '‚ö†Ô∏è'} This Week's Experience:</h4>
                    <ul>${symptoms.map(s => `<li>${s}</li>`).join('')}</ul>
                `;
            } else {
                logEl.style.display = 'none';
            }
        }
        
        // NEW: Hidden damage display for dandelions
        function updateHiddenDamage(id, grimAge, cvRisk, fhri) {
            const damageEl = document.getElementById(`hidden-damage-${id}`);
            
            if (grimAge > 0.5 || cvRisk > 15) {
                damageEl.style.display = 'block';
                damageEl.className = 'hidden-damage-alert';
                damageEl.innerHTML = `
                    <h3>‚ö†Ô∏è Silent Damage Accumulating</h3>
                    <p style="margin-bottom: 15px;"><strong>You appear "functional" (FHRI ${Math.round(fhri)}), but hidden costs are mounting:</strong></p>
                    <div class="damage-metric">
                        <span class="damage-metric-label">GrimAge Biological Aging:</span>
                        <span class="damage-metric-value">+${grimAge.toFixed(1)} years</span>
                    </div>
                    <div class="damage-metric">
                        <span class="damage-metric-label">Cardiovascular Risk Increase:</span>
                        <span class="damage-metric-value">+${Math.round(cvRisk)}%</span>
                    </div>
                    <p style="margin-top: 15px; font-size: 0.9em;"><strong>The Dandelion Trap:</strong> Feeling fine ‚â† Being fine. Your resilience enables exploitation. This silent damage is WORSE than orchid's visible collapse because you stay exposed longer.</p>
                `;
            } else {
                damageEl.style.display = 'none';
            }
        }
        
        function showComparisonSummary() {
            const summaryEl = document.getElementById('comp-summary-content');
            const fhriA = Math.round(comparisonState.scenarioA.data.fhri[12]);
            const fhriB = Math.round(comparisonState.scenarioB.data.fhri[12]);
            const grimAgeA = comparisonState.scenarioA.data.grimAge[12];
            const grimAgeB = comparisonState.scenarioB.data.grimAge[12];
            const cvRiskA = comparisonState.scenarioA.data.cvRisk[12];
            const cvRiskB = comparisonState.scenarioB.data.cvRisk[12];
            
            let html = '<h3>üìä 12-Week Comparison Complete</h3>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">';
            
            html += '<div style="border: 3px solid #667eea; padding: 15px; border-radius: 8px;">';
            html += '<p style="font-weight: 600; color: #667eea; margin-bottom: 10px;">SCENARIO A</p>';
            html += `<p style="font-size: 2em; font-weight: 700; color: ${fhriA >= 70 ? '#48bb78' : fhriA >= 50 ? '#ed8936' : '#f56565'};">FHRI: ${fhriA}</p>`;
            html += `<p>${fhriA >= 70 ? '‚úì Thriving' : fhriA >= 50 ? '‚ö† Struggling' : 'üö® Crisis'}</p>`;
            if (comparisonState.scenarioA.sensitivity === 'dandelion' && grimAgeA > 0) {
                html += `<p style="margin-top: 10px; color: #c53030; font-weight: 600;">Hidden: +${grimAgeA.toFixed(1)}y GrimAge, +${Math.round(cvRiskA)}% CV Risk</p>`;
            }
            html += '</div>';
            
            html += '<div style="border: 3px solid #48bb78; padding: 15px; border-radius: 8px;">';
            html += '<p style="font-weight: 600; color: #48bb78; margin-bottom: 10px;">SCENARIO B</p>';
            html += `<p style="font-size: 2em; font-weight: 700; color: ${fhriB >= 70 ? '#48bb78' : fhriB >= 50 ? '#ed8936' : '#f56565'};">FHRI: ${fhriB}</p>`;
            html += `<p>${fhriB >= 70 ? '‚úì Thriving' : fhriB >= 50 ? '‚ö† Struggling' : 'üö® Crisis'}</p>`;
            if (comparisonState.scenarioB.sensitivity === 'dandelion' && grimAgeB > 0) {
                html += `<p style="margin-top: 10px; color: #c53030; font-weight: 600;">Hidden: +${grimAgeB.toFixed(1)}y GrimAge, +${Math.round(cvRiskB)}% CV Risk</p>`;
            }
            html += '</div>';
            
            html += '</div>';
            
            html += '<p style="margin-top: 20px;"><strong>Key Insights:</strong></p>';
            const diff = Math.abs(fhriA - fhriB);
            if (diff > 20) {
                html += `<p>Substantial FHRI difference (${diff} points) demonstrates how institutional design determines outcomes far more than individual effort.</p>`;
            }
            
            // NEW: Dandelion-specific warning
            const isDandelionA = comparisonState.scenarioA.sensitivity === 'dandelion';
            const isDandelionB = comparisonState.scenarioB.sensitivity === 'dandelion';
            
            if ((isDandelionA && comparisonState.scenarioA.environment === 'extractive' && fhriA > 50) ||
                (isDandelionB && comparisonState.scenarioB.environment === 'extractive' && fhriB > 50)) {
                html += '<p style="margin-top: 15px; padding: 15px; background: #fff5f5; border-left: 4px solid #f56565; border-radius: 4px;">';
                html += '<strong>‚ö†Ô∏è The Dandelion Trap Demonstrated:</strong> ';
                html += 'An FHRI above 50 looks "functional," but dandelions accumulate severe hidden damage in extractive environments. ';
                html += `Total harm (visible FHRI decline + hidden biological aging) is GREATER than orchid's visible collapse. `;
                html += 'This is why low turnover can mask worse outcomes than high turnover.';
                html += '</p>';
            }
            
            summaryEl.innerHTML = html;
            document.getElementById('comp-final-summary').style.display = 'block';
            
            announce('Comparison complete. Review summary for detailed results.');
        }
        
        function resetComparison() {
            pauseComparison();
            comparisonState.week = 0;
            comparisonState.choicePointShown = false;
            document.getElementById('comp-week-display').textContent = '0';
            document.getElementById('comp-final-summary').style.display = 'none';
            document.getElementById('choice-modal').style.display = 'none';
            
            // Keep speed setting - don't reset it
            // comparisonState.speed stays as user configured
            
            comparisonState.scenarioA.data = { 
                lgc: [calculateInitialLGC(comparisonState.scenarioA.sensitivity)], 
                cpfc: [0.85], 
                mfp: [0], 
                fhri: [78],
                grimAge: [0],
                cvRisk: [0]
            };
            comparisonState.scenarioA.events = [{week: 0, type: 'milestone', text: 'Simulation begins'}];
            comparisonState.scenarioA.choiceMade = null;
            
            comparisonState.scenarioB.data = { 
                lgc: [calculateInitialLGC(comparisonState.scenarioB.sensitivity)], 
                cpfc: [0.85], 
                mfp: [0], 
                fhri: [78],
                grimAge: [0],
                cvRisk: [0]
            };
            comparisonState.scenarioB.events = [{week: 0, type: 'milestone', text: 'Simulation begins'}];
            comparisonState.scenarioB.choiceMade = null;
            
            updateComparisonDisplay();
            announce('Comparison reset to week zero. Speed setting maintained.');
        }
    </script>
</body>
</html>
